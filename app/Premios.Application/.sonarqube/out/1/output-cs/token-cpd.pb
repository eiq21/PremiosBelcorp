ﬂw
ÉC:\Miguel\GitHub\PremiosBelcorp\app\Premios.Application\Belcorp.Premios.Infrastructure.Data.Core\Extensions\UnitOfWorkExtensions.cs
	namespace 	
Belcorp
 
. 
Premios 
. 
Infrastructure (
.( )
Data) -
.- .
Core. 2
.2 3

Extensions3 =
{ 
public 

static 
class  
UnitOfWorkExtensions ,
{ 
public 
static 
IEnumerable !
<! "
T" #
># $
ExecuteSqlQuery% 4
<4 5
T5 6
>6 7
(7 8
this8 <
IUnitOfWork= H

unitOfWorkI S
,S T
stringU [
procedureName\ i
,i j
Objectk q

parametersr |
)| }
{ 	
dynamic 
context 
= 

unitOfWork (
.( )
GetType) 0
(0 1
)1 2
.2 3
GetField3 ;
(; <
$str< F
,F G
BindingFlagsH T
.T U
InstanceU ]
|^ _
BindingFlags` l
.l m
	NonPublicm v
)v w
.w x
GetValue	x Ä
(
Ä Å

unitOfWork
Å ã
)
ã å
;
å ç
DatabaseFacade 
database #
=$ %
context& -
.- .
Database. 6
;6 7

IDbCommand 
cmd 
= 
database %
.% &
GetDbConnection& 5
(5 6
)6 7
.7 8
CreateCommand8 E
(E F
)F G
;G H
cmd 
. 
CommandText 
= 
procedureName +
;+ ,
cmd 
. 
CommandType 
= 
CommandType )
.) *
StoredProcedure* 9
;9 :
object 
[ 
] 
sqlParameters "
=# $
{% &
}' (
;( )
if 
( 

parameters 
!= 
null "
)" #
{$ %
sqlParameters 
=  !
GetParametersSqlQuery! 6
(6 7

parameters7 A
)A B
;B C
} 
if 
( 
sqlParameters 
. 
Any !
(! "
)" #
)# $
{ 
foreach   
(   
object   
sqlParameter    ,
in  - /
sqlParameters  0 =
)  = >
{!! 
cmd"" 
."" 

Parameters"" "
.""" #
Add""# &
(""& '
sqlParameter""' 3
)""3 4
;""4 5
}## 
}$$ 
IEnumerable&& 
<&& 
T&& 
>&& 
queryResult&& &
;&&& '
	DataTable'' 
	dataTable'' 
=''  !
new''" %
	DataTable''& /
(''/ 0
)''0 1
;''1 2
if(( 
((( 
cmd(( 
.(( 

Connection(( 
.(( 
State(( $
.(($ %
HasFlag((% ,
(((, -
ConnectionState((- <
.((< =
Closed((= C
)((C D
)((D E
cmd)) 
.)) 

Connection)) 
.)) 
Open)) #
())# $
)))$ %
;))% &
try++ 
{,, 
using-- 
(-- 
IDataReader-- "
reader--# )
=--* +
cmd--, /
.--/ 0
ExecuteReader--0 =
(--= >
)--> ?
)--? @
{.. 
	dataTable// 
.// 
Load// "
(//" #
reader//# )
)//) *
;//* +
queryResult00 
=00  !
	ConvertTo00" +
<00+ ,
T00, -
>00- .
(00. /
	dataTable00/ 8
)008 9
;009 :
}11 
}22 
finally33 
{44 
cmd55 
.55 

Connection55 
.55 
Close55 $
(55$ %
)55% &
;55& '
}66 
return99 
queryResult99 
;99 
}:: 	
public<< 
static<< 
void<< 
ExecuteSqlNonQuery<< -
(<<- .
this<<. 2
IUnitOfWork<<3 >

unitOfWork<<? I
,<<I J
string<<K Q
procedureName<<R _
,<<_ `
Object<<a g

parameters<<h r
)<<r s
{== 	
dynamic>> 
context>> 
=>> 

unitOfWork>> (
.>>( )
GetType>>) 0
(>>0 1
)>>1 2
.>>2 3
GetField>>3 ;
(>>; <
$str>>< F
,>>F G
BindingFlags>>H T
.>>T U
Instance>>U ]
|>>^ _
BindingFlags>>` l
.>>l m
	NonPublic>>m v
)>>v w
.>>w x
GetValue	>>x Ä
(
>>Ä Å

unitOfWork
>>Å ã
)
>>ã å
;
>>å ç
DatabaseFacade@@ 
database@@ #
=@@$ %
context@@& -
.@@- .
Database@@. 6
;@@6 7

IDbCommandBB 
cmdBB 
=BB 
databaseBB %
.BB% &
GetDbConnectionBB& 5
(BB5 6
)BB6 7
.BB7 8
CreateCommandBB8 E
(BBE F
)BBF G
;BBG H
cmdCC 
.CC 
CommandTextCC 
=CC 
procedureNameCC +
;CC+ ,
cmdDD 
.DD 
CommandTypeDD 
=DD 
CommandTypeDD )
.DD) *
StoredProcedureDD* 9
;DD9 :
objectEE 
[EE 
]EE 
sqlParametersEE "
=EE# $!
GetParametersSqlQueryEE% :
(EE: ;

parametersEE; E
)EEE F
;EEF G
ifGG 
(GG 
sqlParametersGG 
.GG 
AnyGG !
(GG! "
)GG" #
)GG# $
{HH 
foreachII 
(II 
objectII 
sqlParameterII  ,
inII- /
sqlParametersII0 =
)II= >
{JJ 
cmdKK 
.KK 

ParametersKK "
.KK" #
AddKK# &
(KK& '
sqlParameterKK' 3
)KK3 4
;KK4 5
}LL 
}MM 
ifPP 
(PP 
cmdPP 
.PP 

ConnectionPP 
.PP 
StatePP $
.PP$ %
HasFlagPP% ,
(PP, -
ConnectionStatePP- <
.PP< =
ClosedPP= C
)PPC D
)PPD E
cmdQQ 
.QQ 

ConnectionQQ 
.QQ 
OpenQQ #
(QQ# $
)QQ$ %
;QQ% &
trySS 
{TT 
cmdUU 
.UU 
ExecuteNonQueryUU #
(UU# $
)UU$ %
;UU% &
}VV 
finallyWW 
{XX 
cmdYY 
.YY 

ConnectionYY 
.YY 
CloseYY $
(YY$ %
)YY% &
;YY& '
}ZZ 
}[[ 	
private^^ 
static^^ 
object^^ 
[^^ 
]^^ !
GetParametersSqlQuery^^  5
(^^5 6
Object^^6 <

parameters^^= G
)^^G H
{__ 	
IList`` 
<`` 
SqlParameter`` 
>`` 
listaParametro``  .
=``/ 0
new``1 4
List``5 9
<``9 :
SqlParameter``: F
>``F G
(``G H
)``H I
;``I J
foreachbb 
(bb 
PropertyInfobb !
propbb" &
inbb' )

parametersbb* 4
.bb4 5
GetTypebb5 <
(bb< =
)bb= >
.bb> ?
GetPropertiesbb? L
(bbL M
)bbM N
)bbN O
{cc 
dynamicdd 
valordd 
=dd 
propdd  $
.dd$ %
GetValuedd% -
(dd- .

parametersdd. 8
,dd8 9
nulldd: >
)dd> ?
;dd? @
Typeff 
typeff 
=ff 
Nullableff $
.ff$ %
GetUnderlyingTypeff% 6
(ff6 7
propff7 ;
.ff; <
PropertyTypeff< H
)ffH I
;ffI J
typegg 
=gg 
(gg 
typegg 
==gg 
nullgg  $
)gg$ %
?gg& '
propgg( ,
.gg, -
PropertyTypegg- 9
:gg: ;
typegg< @
;gg@ A
ifii 
(ii 
typeii 
==ii 
typeofii "
(ii" #
Systemii# )
.ii) *
Dataii* .
.ii. /
	DataTableii/ 8
)ii8 9
)ii9 :
{jj 
listaParametrokk "
.kk" #
Addkk# &
(kk& '
newkk' *
SqlParameterkk+ 7
(kk7 8
)kk8 9
{kk: ;
ParameterNamekk< I
=kkJ K
$strkkL O
+kkP Q
propkkR V
.kkV W
NamekkW [
,kk[ \
Valuekk] b
=kkc d
valorkke j
,kkj k
	SqlDbTypekkl u
=kkv w
	SqlDbType	kkx Å
.
kkÅ Ç

Structured
kkÇ å
}
kkç é
)
kké è
;
kkè ê
}ll 
elsemm 
{nn 
listaParametrooo "
.oo" #
Addoo# &
(oo& '
newoo' *
SqlParameteroo+ 7
(oo7 8
)oo8 9
{oo: ;
ParameterNameoo< I
=ooJ K
$strooL O
+ooP Q
propooR V
.ooV W
NameooW [
,oo[ \
Valueoo] b
=ooc d
valorooe j
}ook l
)ool m
;oom n
}pp 
}qq 
returnss 
listaParametross !
.ss! "
ToArrayss" )
(ss) *
)ss* +
;ss+ ,
}tt 	
publicuu 
staticuu 
Tuu 

CreateItemuu "
<uu" #
Tuu# $
>uu$ %
(uu% &
DataRowuu& -
rowuu. 1
)uu1 2
{vv 	
stringww 

columnNameww 
;ww 
Txx 
objxx 
=xx 
defaultxx 
(xx 
Txx 
)xx 
;xx 
ifyy 
(yy 
rowyy 
!=yy 
nullyy 
)yy 
{zz 
obj{{ 
={{ 
	Activator{{ 
.{{  
CreateInstance{{  .
<{{. /
T{{/ 0
>{{0 1
({{1 2
){{2 3
;{{3 4
foreach|| 
(|| 

DataColumn|| #
column||$ *
in||+ -
row||. 1
.||1 2
Table||2 7
.||7 8
Columns||8 ?
)||? @
{}} 

columnName~~ 
=~~  
column~~! '
.~~' (

ColumnName~~( 2
;~~2 3
PropertyInfo
ÄÄ  
prop
ÄÄ! %
=
ÄÄ& '
obj
ÄÄ( +
.
ÄÄ+ ,
GetType
ÄÄ, 3
(
ÄÄ3 4
)
ÄÄ4 5
.
ÄÄ5 6
GetProperty
ÄÄ6 A
(
ÄÄA B

columnName
ÄÄB L
,
ÄÄL M
BindingFlags
ÄÄN Z
.
ÄÄZ [

IgnoreCase
ÄÄ[ e
|
ÄÄf g
BindingFlags
ÄÄh t
.
ÄÄt u
Public
ÄÄu {
|
ÄÄ| }
BindingFlagsÄÄ~ ä
.ÄÄä ã
InstanceÄÄã ì
)ÄÄì î
;ÄÄî ï
try
ÅÅ 
{
ÇÇ 
object
ÑÑ 
value
ÑÑ $
=
ÑÑ% &
(
ÑÑ' (
row
ÑÑ( +
[
ÑÑ+ ,

columnName
ÑÑ, 6
]
ÑÑ6 7
.
ÑÑ7 8
GetType
ÑÑ8 ?
(
ÑÑ? @
)
ÑÑ@ A
==
ÑÑB D
typeof
ÑÑE K
(
ÑÑK L
DBNull
ÑÑL R
)
ÑÑR S
)
ÑÑS T
?
ÖÖ 
null
ÖÖ 
:
ÖÖ  
row
ÖÖ! $
[
ÖÖ$ %

columnName
ÖÖ% /
]
ÖÖ/ 0
;
ÖÖ0 1
prop
áá 
.
áá 
SetValue
áá %
(
áá% &
obj
áá& )
,
áá) *
value
áá+ 0
,
áá0 1
null
áá2 6
)
áá6 7
;
áá7 8
}
àà 
catch
ââ 
{
ää 
throw
ãã 
;
ãã 
}
çç 
}
éé 
}
èè 
return
êê 
obj
êê 
;
êê 
}
ëë 	
public
íí 
static
íí 
IList
íí 
<
íí 
T
íí 
>
íí 
	ConvertTo
íí (
<
íí( )
T
íí) *
>
íí* +
(
íí+ ,
IList
íí, 1
<
íí1 2
DataRow
íí2 9
>
íí9 :
rows
íí; ?
)
íí? @
{
ìì 	
IList
îî 
<
îî 
T
îî 
>
îî 
list
îî 
=
îî 
null
îî  
;
îî  !
if
ïï 
(
ïï 
rows
ïï 
!=
ïï 
null
ïï 
)
ïï 
{
ññ 
list
óó 
=
óó 
new
óó 
List
óó 
<
óó  
T
óó  !
>
óó! "
(
óó" #
)
óó# $
;
óó$ %
foreach
òò 
(
òò 
DataRow
òò  
row
òò! $
in
òò% '
rows
òò( ,
)
òò, -
{
ôô 
T
öö 
item
öö 
=
öö 

CreateItem
öö '
<
öö' (
T
öö( )
>
öö) *
(
öö* +
row
öö+ .
)
öö. /
;
öö/ 0
list
õõ 
.
õõ 
Add
õõ 
(
õõ 
item
õõ !
)
õõ! "
;
õõ" #
}
úú 
}
ùù 
return
ûû 
list
ûû 
;
ûû 
}
üü 	
public
†† 
static
†† 
IList
†† 
<
†† 
T
†† 
>
†† 
	ConvertTo
†† (
<
††( )
T
††) *
>
††* +
(
††+ ,
	DataTable
††, 5
table
††6 ;
)
††; <
{
°° 	
if
¢¢ 
(
¢¢ 
table
¢¢ 
==
¢¢ 
null
¢¢ 
)
¢¢ 
return
££ 
null
££ 
;
££ 
List
•• 
<
•• 
DataRow
•• 
>
•• 
rows
•• 
=
••  
new
••! $
List
••% )
<
••) *
DataRow
••* 1
>
••1 2
(
••2 3
)
••3 4
;
••4 5
foreach
¶¶ 
(
¶¶ 
DataRow
¶¶ 
row
¶¶  
in
¶¶! #
table
¶¶$ )
.
¶¶) *
Rows
¶¶* .
)
¶¶. /
rows
ßß 
.
ßß 
Add
ßß 
(
ßß 
row
ßß 
)
ßß 
;
ßß 
return
©© 
	ConvertTo
©© 
<
©© 
T
©© 
>
©© 
(
©©  
rows
©©  $
)
©©$ %
;
©©% &
}
™™ 	
}
≠≠ 
}ÆÆ 